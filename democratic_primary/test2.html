<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.7.1/d3-tip.min.js"></script>
    <link rel="stylesheet" href="https://use.typekit.net/htk2wjy.css">
    <link rel="stylesheet" href="index.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    
</head>

<body>
    <script>
        var keyState = "Iowa"
    </script>

    
    <select id="selectboxvote" class="custom-select" style="width:200px;">
        <option value="vote">Projected Vote Share</option>
    </select>
    <div id="pollavg"></div>



    <script>

        var margin = { top: 20, right: 40, bottom: 100, left: 20 }
        var width = 1000 - margin.left - margin.right
        var height = 600 - margin.top - margin.bottom

        var demScale = d3.scaleLinear()
            .domain([0, 50])
            .range(["white", "#0091FF"]);

        d3.csv("time.csv", function (error, data) {
            var keys = data.columns.slice(1);

            var data = data.filter(function (d) { return d.state == keyState; });

            var datatype = "vote"

            var parseTime = d3.timeParse("%Y-%m-%d"),
                formatDate = d3.timeFormat("%b - %d"),
                formatMonth = d3.timeFormat("%Y-%m-%d"),
                bisectDate = d3.bisector(d => d.date).left,
                formatValue = d3.format(",.0f");

            data.forEach(function (d) {
                d.date = parseTime(d.forecastdate);
                d.primarydate = parseTime(d.primarydate);
                return d;
            })

            //today
            var now = d3.max(data, d => d.forecastdate)

            var nowarray = data.filter(function (d) { return d.forecastdate == now; });

            var copytwo = keys.filter(f => f.includes(datatype))

            var asoftoday = copytwo.map(function (id) {
                return {
                    values: nowarray.map(d => { return +d[id] })
                };
            });

            
            console.log(now)
            console.log(nowarray)
            console.log(asoftoday)

            console.log(data)

            var svg = d3.select("#vote").append("svg")
                .attr("viewBox", "0 0 1000 600")
                .append('g')
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var svgnow = svg.append('g')
                .attr('class', 'gnow')
                .attr("transform", "translate(100,500)")

            var nowv = svgnow.selectAll('.now')
                .data(asoftoday)
                .enter().append('g')
                .attr("class", "now")
                .attr("transform", function (d, i) { return "translate(" + i * 100 + ",0)" })

            nowv.append("rect")
                .attr("y", -17.5)
                .attr("x", -37.5)
                .attr("width", 75)
                .attr("height", 25)
                .attr("rx", 10)
                .attr("fill",d=> demScale(d.values))

            nowv.append("text")
                .attr("class", "now-text")
                .style("fill", "Black")
                .attr("text-anchor", "middle")
                .style("font-size", 14)
                .style("font-weight", 700)
                .text(d => d.values + "%")
            //one month ago
            now = parseTime(now)

            var monthago = formatMonth(d3.utcMonth.offset(now, -1))

            var montharray = data.filter(function (d) { return d.forecastdate == monthago; });

            var copythree = keys.filter(f => f.includes(datatype))

            var onemonthago = copythree.map(function (id) {
                return {
                    values: montharray.map(d => { return +d[id] })
                };
            });

            console.log(monthago)
            console.log(montharray)
            console.log(onemonthago)

           

              var svgmonth = svg.append('g')
                .attr('class', 'gmonth')
                .attr("transform", "translate(100,530)")

            var monthv = svgmonth.selectAll('.now')
                .data(onemonthago)
                .enter().append('g')
                .attr("class", "month")
                .attr("transform", function (d, i) { return "translate(" + i * 100 + ",0)" })

            monthv.append("rect")
                .attr("y", -17.5)
                .attr("x", -37.5)
                .attr("width", 75)
                .attr("height", 25)
                .attr("rx", 10)
                .attr("fill",d=> demScale(d.values))

            monthv.append("text")
                .attr("class", "now-text")
                .style("fill", "Black")
                .attr("text-anchor", "middle")
                .style("font-size", 14)
                .style("font-weight", 700)
                .text(d => d.values + "%")



            var mindate = new Date(2019, 5, 1),
                maxdate = d3.max(data, d => d.primarydate)
            demadjust = new Date(2020, 0, 4);

            var x = d3.scaleTime()
                .rangeRound([margin.left, width - margin.right])
                .domain([mindate, maxdate])

            var y = d3.scaleLinear()
                .rangeRound([height - margin.bottom, margin.top]);

            var z = d3.scaleOrdinal()
                .range(["#00FF90", "#00B050", "#006541", "#98d2f8", "#0077FF", "#002E66", "#E7B5FF", "#B722FF", "purple"])
                ;

            var line = d3.line()
                .curve(d3.curveCardinal)
                .x(d => x(d.date))
                .y(d => y(d.degrees));

            svg.append("g")
                .attr("class", "x-axis")
                .attr("transform", "translate(0," + (height - margin.bottom) + ")")
                .call(d3.axisBottom(x).tickFormat(d3.timeFormat("%b")));

            svg.append("g")
                .attr("class", "y-axis")
                .attr("transform", "translate(" + margin.left + ",0)");

            var focus = svg.append("g")
                .attr("class", "focus")
                .style("display", "none");

            focus.append("line").attr("class", "lineHover")
                .style("stroke", "#999")
                .attr("stroke-width", 1)
                .style("shape-rendering", "crispEdges")
                .style("opacity", 0)
                .attr("y1", -height)
                .attr("y2", -40);

            focus.append("text").attr("class", "lineHoverDate")
                .attr("text-anchor", "middle")
                .attr("font-size", 12);

            var overlay = svg.append("rect")
                .attr("class", "overlay")
                .attr("x", margin.left)
                .attr("width", width - margin.right - margin.left)
                .attr("height", height)

            update(d3.select('#selectboxvote').property('value'), 0);

            function update(input, speed) {

                var copy = keys.filter(f => f.includes(input))

                var cities = copy.map(function (id) {
                    return {
                        id: id,
                        values: data.map(d => { return { date: d.date, degrees: +d[id] } })
                    };
                });

                y.domain([
                    d3.min(cities, d => d3.min(d.values, c => c.degrees)),
                    d3.max(cities, d => d3.max(d.values, c => c.degrees))
                ]).nice();

                svg.selectAll(".y-axis").transition()
                    .duration(speed)
                    .call(d3.axisLeft(y).tickSize(-width + margin.right + margin.left))

                var city = svg.selectAll(".cities")
                    .data(cities);

                city.exit().remove();

                city.enter().insert("g", ".focus").append("path")
                    .attr("class", "line cities")
                    .style("stroke", d => z(d.id))
                    .merge(city)
                    .transition().duration(speed)
                    .attr("d", d => line(d.values))

                tooltip(copy);
            }

            function tooltip(copy) {
                var rect = focus.selectAll(".lineHoverRect")
                    .data(copy)

                rect.enter().append("rect")
                    .attr("class", "lineHoverRect")
                    .attr("y", 452.5)
                    .attr("x", 62.5)
                    .attr("width", 75)
                    .attr("height", 25)
                    .attr("rx", 10)
                    .attr("transform", (_, i) => "translate(" + i * 100 + ",0)")
                    .merge(rect);

                var labels = focus.selectAll(".lineHoverText")
                    .data(copy)

                labels.enter().append("text")
                    .attr("class", "lineHoverText")
                    .attr("text-anchor", "middle")
                    .attr("font-size", 14)
                    .attr("dx", (_, i) => 1 + i * 100 + "px")
                    .merge(labels);







                var circles = focus.selectAll(".hoverCircle")
                    .data(copy)

                circles.enter().append("circle")
                    .attr("class", "hoverCircle")
                    .style("fill", d => z(d))
                    .attr("r", 2.5)
                    .merge(circles);

                svg.selectAll(".overlay")
                    .on("mouseover", function () { focus.style("display", null); })
                    .on("mouseout", function () { focus.style("display", "display"); })
                    .on("mousemove", mousemove);

                function mousemove() {

                    var x0 = x.invert(d3.mouse(this)[0]),
                        i = bisectDate(data, x0, 1),
                        d0 = data[i - 1],
                        d1 = data[i],
                        d = x0 - d0.date > d1.date - x0 ? d1 : d0;

                    focus.select(".lineHover")
                        .attr("transform", "translate(" + x(d.date) + "," + height + ")");

                    focus.select(".lineHoverDate")
                        .attr("x",0)
                        .attr("y",470)
                        .attr("text-anchor","start")
                        .style("font-size", 12)
                .style("font-weight", 700)
                        .text(formatDate(d.date));

                    focus.selectAll(".hoverCircle")
                        .attr("cy", e => y(d[e]))
                        .attr("cx", x(d.date));

                    focus.selectAll(".lineHoverRect")
                        .style("fill", e => demScale(d[e]))
                        ;

                    focus.selectAll(".lineHoverText")
                        .attr("transform",
                            "translate(" + 100 + "," + 470 + ")").style("font-weight", 700)
                        .text(e => d[e] + "%");




                }
            }

            var cands = ["Biden", "Bloomberg", "Booker", "Buttigieg", "Klobuchar", "Sanders", "Steyer", "Warren", "Yang"]

            var svgLegend = svg.append('g')
                .attr('class', 'gLegend')
                .attr("transform", "translate(100,440)")

            var legend = svgLegend.selectAll('.legend')
                .data(cands)
                .enter().append('g')
                .attr("class", "legend")
                .attr("transform", function (d, i) { return "translate(" + i * 100 + ",0)" })

                svg.append("text")
                .attr("x",0)
                        .attr("y",500)
                        .attr("text-anchor","start")
                        .style("font-size", 12)
                .style("font-weight", 700)
                .text("Today")

                svg.append("text")
                .attr("x",0)
                        .attr("y",530)
                        .attr("text-anchor","start")
                        .style("font-size", 12)
                .style("font-weight", 700)
                .text("Month Ago")

            legend.append("text")
                .attr("class", "legend-text")
                .style("fill", d=> z(d))
                .attr("text-anchor", "middle")
                .style("font-size", 14)
                .style("font-weight", 700)
                .text(d => d)


        })

    </script>
</body>